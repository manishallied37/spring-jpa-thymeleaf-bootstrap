<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title></title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet"
          th:href="@{https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback}">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" th:href="@{plugins/fontawesome-free/css/all.min.css}">
    <!-- overlayScrollbars -->
    <link rel="stylesheet" th:href="@{plugins/overlayScrollbars/css/OverlayScrollbars.min.css}">
    <!-- Theme style -->
    <link rel="stylesheet" th:href="@{dist/css/adminlte.min.css}">
    <!-- IonIcons -->
    <link rel="stylesheet" th:href="@{https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css}">
    <!-- overlayScrollbars -->
    <link rel="stylesheet" th:href="@{plugins/overlayScrollbars/css/OverlayScrollbars.min.css}">
    <!-- Select2 -->
    <link rel="stylesheet" th:href="@{plugins/select2/css/select2.min.css}">
    <!-- Bootstrap4 -->
    <link rel="stylesheet" th:href="@{plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css}">
    <!-- Bootstrap4 Duallistbox -->
    <link rel="stylesheet" th:href="@{plugins/bootstrap4-duallistbox/bootstrap-duallistbox.min.css}">
    <!-- BS Stepper -->
    <link rel="stylesheet" th:href="@{plugins/bs-stepper/css/bs-stepper.min.css}">
    <!-- dropzonejs -->
    <link rel="stylesheet" th:href="@{plugins/dropzone/min/dropzone.min.css}">
    <!-- Toastr -->
    <link rel="stylesheet" th:href="@{plugins/toastr/toastr.min.css}">
    <!-- Swagger -->
    <link href="/swagger-editor/swagger-ui.css" rel="stylesheet" type="text/css">


    <style>
        #load {
          position: fixed;
          left: 0px;
          top: 0px;
          width: 100%;
          height: 100%;
          z-index: 9999;
          background: url(images/loader.gif) center no-repeat #fff;
          opacity: 1;
        }

        .nav-sidebar .nav-treeview > .nav-item > .nav-link {
          background-color: transparent !important;
          color: #777 !important;
        }

        .dropdown-menu-lg {
          max-height: 420px;
          overflow: hidden;
        }

        #cartItems {
          max-height: 300px;
          overflow-y: auto;
        }

        #cartItems::-webkit-scrollbar {
          width: 6px;
        }

        #cartItems::-webkit-scrollbar-thumb {
          background: #ccc;
          border-radius: 4px;
        }

        .dropdown-item {
          white-space: normal !important;
        }

        .cart-row {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 8px;
        }

        .cart-text {
          flex: 1;
          min-width: 0;
          word-break: break-word;
          overflow-wrap: break-word;
        }

                .topbar {
                    display: none;
                }
    </style>

</head>

<body class="hold-transition  sidebar-mini layout-fixed layout-navbar-fixed layout-footer-fixed">

<div id="load"></div>

<!-- HOME SECTION -->
<div class="wrapper">


    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-light" style="background:rgb(255, 255, 255);">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>

        </ul>

        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">

            <li class="nav-item">
                <a class="nav-link" data-widget="fullscreen" href="#" role="button">
                    <i class="fas fa-expand-arrows-alt"></i>
                </a>
            </li>

        </ul>
    </nav>
    <!-- /.navbar -->

    <!-- Main Sidebar Container -->
    <aside class="main-sidebar sidebar-light-primary elevation-4">
        <!-- Brand Logo -->
        <a class="brand-link" href="#">
            <img alt="" class="brand-image  " id="navbar-logo" style="width: 210px;" th:src="@{images/2.jpg}">
            <!--<span class="brand-text font-weight-dark ">ALLIED GLOBETECH</span>-->
        </a>

        <!-- Sidebar -->
        <div class="sidebar">


            <!-- Sidebar Menu -->
            <nav class="mt-2">

                <ul class="nav nav-pills nav-sidebar nav-child-indent flex-column text-white rolelist"
                    data-accordion="false" data-widget="treeview" role="menu">

                    <li class="nav-item text-bold"
                        th:classappend="
						        ${menu.children.size() > 0} ? 'has-treeview' : ''
						    "
                        th:each="menu : ${navMenus}">

                        <a class="nav-link"
                           th:href="${menu.children.size() > 0} ? '#' : @{${menu.route}}">

                            <i class="nav-icon text-navy"
                               th:classappend="${menu.icon}"></i>

                            <p>
                                <i class="fas fa-angle-right right"
                                   th:if="${menu.children.size() > 0}"></i>
                                <th:block th:text="${menu.title}"></th:block>
                            </p>
                        </a>

                        <ul class="nav nav-treeview"
                            th:if="${menu.children.size() > 0}"
                            th:insert="fragments/sidebar-menu :: childMenu(${menu.children})">
                        </ul>

                    </li>
                </ul>

            </nav>
            <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
    </aside>

    <div class="content-wrapper">

        <!-- Header -->
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1>API Cart</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right" id="dynamicBreadcrumb"></ol>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">

                <div class="card">
                    <div class="card-body">

                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="cartTable">
                                <thead class="thead-light">
                                <tr>
                                    <th>API Name</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th width="120">Action</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>

                        <div class="mt-3 text-right">
                            <button class="btn btn-success" id="checkoutBtn">
                                Proceed to Subscribe
                            </button>
                        </div>

                    </div>
                </div>

            </div>
        </section>

    </div>

    <!-- /.content-wrapper -->


    <!-- Main Footer -->
    <div th:replace="fragments/footer :: footer"></div>
</div>

<!-- REQUIRED SCRIPTS -->
<!-- jQuery -->
<script th:src="@{plugins/jquery/jquery.min.js}"></script>
<!-- Bootstrap -->
<script th:src="@{plugins/bootstrap/js/bootstrap.bundle.min.js}"></script>
<!-- overlayScrollbars -->
<script th:src="@{plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js}"></script>
<!-- AdminLTE App -->
<script th:src="@{static/dist/js/adminlte.js}"></script>
<!-- Bootstrap Switch -->
<script th:src="@{plugins/bootstrap-switch/js/bootstrap-switch.min.js}"></script>
<!-- BS-Stepper -->
<script th:src="@{plugins/bs-stepper/js/bs-stepper.min.js}"></script>
<!-- dropzonejs -->
<script th:src="@{plugins/dropzone/min/dropzone.min.js}"></script>
<!-- AdminLTE App -->
<script th:src="@{dist/js/adminlte.min.js}"></script>
<!-- AdminLTE for demo purposes -->
<script th:src="@{dist/js/demo.js}"></script>

<!-- PAGE PLUGINS -->
<!-- jQuery Mapael -->
<script th:src="@{plugins/jquery-mousewheel/jquery.mousewheel.js}"></script>
<script th:src="@{plugins/raphael/raphael.min.js}"></script>
<script th:src="@{plugins/jquery-mapael/jquery.mapael.min.js}"></script>
<script th:src="@{plugins/jquery-mapael/maps/usa_states.min.js}"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js" type="text/javascript"></script>

<!-- Developer Script -->
<script th:src="@{dist/js/Common.js}"></script>

<script th:inline="javascript">
    const NAV_MENUS = /*[[${navMenus}]]*/ [];
    const CURRENT_ROUTE = /*[[${#httpServletRequest.requestURI}]]*/ '';
</script>

<script th:src="@{/swagger-editor/js-yaml-min.js}"></script>
<script th:src="@{/swagger-editor/swagger-ui-bundle.js}"></script>
<script th:src="@{/swagger-editor/swagger-ui-standalone-preset.js}"></script>

<script th:src="@{dist/js/SecurityEncryption.js}"></script>

<script>

    console.log("Cart page JS loaded");
    console.log("LocalStorage apiCart =", localStorage.getItem("API_CART"));

    function getCart() {
            const cart = localStorage.getItem("API_CART");
            return cart ? JSON.parse(cart) : [];
        }
    function saveCart(cart) {
            localStorage.setItem(CART_KEY, JSON.stringify(cart));
        }
        function removeFromCart(apiId) {
        let cart = getCart();

        cart = cart.filter(item => item.id !== apiId);

        saveCart(cart);

        renderCartTable();

        window.dispatchEvent(new Event("cartUpdated"));
    }

    function renderBreadcrumb() {
        const breadcrumb = document.getElementById("dynamicBreadcrumb");
        const referrer = JSON.parse(sessionStorage.getItem("cartReferrer"));

        let html = '';

        if (referrer) {
            html += `
              <li class="breadcrumb-item">
                <a href="${referrer.url}">
                  <i class="fas fa-arrow-left mr-1"></i> ${referrer.title}
                </a>
              </li>
            `;
        } else {
            html += `
              <li class="breadcrumb-item">
                <a href="/explore-apis">Explore APIs</a>
              </li>
            `;
        }

        html += `<li class="breadcrumb-item active">Cart</li>`;
        breadcrumb.innerHTML = html;
    }

    function renderCartTable() {
        const cart = getCart();
        const tbody = document.querySelector("#cartTable tbody");
        tbody.innerHTML = "";

        if (cart.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-muted">
                        No APIs in cart
                    </td>
                </tr>`;
            return;
        }

        cart.forEach(api => {
            tbody.innerHTML += `
                <tr>
                    <td>${api.name}</td>
                    <td>${api.category}</td>
                    <td>
                        <span class="badge badge-warning">Pending</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger remove-from-cart"
                                data-id="${api.id}">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </td>
                </tr>`;
        });

        const subscribeBtn = document.querySelector(".btn-success");
        subscribeBtn.disabled = cart.length === 0;
    }

    document.addEventListener("click", function (e) {
        const btn = e.target.closest(".remove-from-cart");
        if (!btn) return;

        const apiId = btn.dataset.id;

        let cart = getCart();
        cart = cart.filter(api => api.id !== apiId);
        saveCart(cart);

        renderCartTable();
        updateCartCount();
        renderCartDropdown();
        updateSubscribeButton();
    });

    document.getElementById("checkoutBtn")?.addEventListener("click", function () {
        const cart = getCart();
        if (cart.length === 0) {
            alert("Cart is empty");
            return;
        }

        //alert("Proceeding to subscription approval flow");
    });

    renderCartTable();
    renderBreadcrumb();
    
    document.getElementById("checkoutBtn").addEventListener("click", function () {
       window.location.href = "/api-cart-billing"; // target page
	});
</script>


</body>

</html>